<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vérification d'éligibilité au Chèque Numérique</title>
    <style>
        :root {
            --primary-color: #333333;
            --secondary-color: #FF7A59; /* Couleur corail pour les boutons */
            --light-bg: #FFFFFF;
            --border-color: #E8E8E8;
            --success-color: #7EC31F;
            --error-color: #E74C3C;
            --text-color: #333333;
            --light-text: #FFFFFF;
        }
        
        body, html {
            font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            margin: 0;
            padding: 0;
            background-color: #F9F0EC; /* Fond légèrement coloré comme dans la maquette */
        }
        
        .container {
            max-width: 800px;
            width: 95%;
            margin: 40px auto;
            padding: 30px;
            background-color: var(--light-bg);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        h1 {
            font-size: 28px;
            color: var(--primary-color);
            margin-bottom: 10px;
            text-align: center;
            font-weight: 600;
        }
        
        .subtitle {
            font-size: 18px;
            color: var(--secondary-color);
            text-align: center;
            margin-bottom: 25px;
            font-weight: 500;
        }
        
        .more-info {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }
        
        .more-info a {
            color: var(--secondary-color);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }
        
        .more-info a:hover {
            color: #E86A4D;
            text-decoration: underline;
        }
        
        h2 {
            font-size: 22px;
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        
        p {
            color: var(--text-color);
            margin-bottom: 20px;
        }
        
        .search-container {
            display: flex;
            flex-direction: row;
            margin-bottom: 30px;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        #siretInput {
            flex-grow: 1;
            padding: 15px;
            font-size: 16px;
            border: 1px solid var(--border-color);
            border-right: none;
            border-radius: 6px 0 0 6px;
            outline: none;
        }
        
        button {
            padding: 15px 25px;
            font-size: 16px;
            background-color: var(--secondary-color);
            color: var(--light-text);
            border: none;
            border-radius: 0 6px 6px 0;
            cursor: pointer;
            transition: background-color 0.3s;
            font-weight: 500;
        }
        
        button:hover {
            background-color: #E86A4D;
        }
        
        .results-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 30px;
        }
        
        #company-info {
            padding: 20px;
            background-color: var(--light-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        #company-info p {
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        #result {
            padding: 20px;
            background-color: var(--light-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .criteria-list {
            margin-top: 30px;
            padding: 20px;
            background-color: var(--light-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .criteria-list h3 {
            margin-top: 0;
            color: var(--primary-color);
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .criteria-list ul {
            padding-left: 0;
            list-style-type: none;
            margin-bottom: 0;
        }
        
        .criteria-list ul li {
            position: relative;
            padding: 12px 12px 12px 40px;
            margin-bottom: 10px;
            background-color: #F9F9F9;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }
        
        .criteria-list ul li:before {
            content: '\2713';
            position: absolute;
            left: 15px;
            color: var(--success-color);
            font-weight: bold;
        }
        
        .eligible {
            color: var(--success-color);
            font-weight: bold;
            padding: 12px;
            background-color: rgba(126, 195, 31, 0.1);
            border-radius: 6px;
            display: inline-block;
            margin-top: 10px;
        }
        
        .not-eligible {
            color: var(--error-color);
            font-weight: bold;
            padding: 12px;
            background-color: rgba(231, 76, 60, 0.1);
            border-radius: 6px;
            display: inline-block;
            margin-top: 10px;
        }
        
        .criteria-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 12px;
            background-color: #F9F9F9;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }
        
        .criteria-status {
            margin-right: 15px;
            font-size: 18px;
        }
        
        .result-section {
            margin-bottom: 30px;
        }
        
        .result-section h3 {
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 15px;
            color: var(--primary-color);
            font-size: 18px;
            font-weight: 600;
        }
        
        .reasons-list {
            background-color: rgba(231, 76, 60, 0.05);
            padding: 15px;
            border-left: 4px solid var(--error-color);
            margin-top: 15px;
            border-radius: 6px;
        }
        
        .reasons-list ul {
            margin: 10px 0 0 0;
            padding-left: 20px;
        }
        
        /* Style pour les icônes comme dans la maquette */
        .icon {
            display: inline-block;
            width: 24px;
            height: 24px;
            margin-right: 10px;
            vertical-align: middle;
        }
        
        /* Media Queries pour la responsivité */
        @media screen and (max-width: 768px) {
            .container {
                margin: 20px auto;
                padding: 20px;
                width: 90%;
            }
            
            h1 {
                font-size: 24px;
            }
            
            .results-layout {
                grid-template-columns: 1fr;
                display: flex;
                flex-direction: column;
            }
            
            #company-info, #result {
                width: 100%;
                box-sizing: border-box;
                margin-bottom: 20px;
            }
            
            #company-info p {
                white-space: normal;
                word-break: break-word;
            }
        }
        
        @media screen and (max-width: 480px) {
            .container {
                margin: 10px auto;
                padding: 15px;
                width: 95%;
            }
            
            h1 {
                font-size: 20px;
            }
            
            .search-container {
                flex-direction: column;
            }
            
            #siretInput {
                border-radius: 6px 6px 0 0;
                border-right: 1px solid var(--border-color);
                border-bottom: none;
            }
            
            button {
                border-radius: 0 0 6px 6px;
                width: 100%;
            }
            
            .criteria-item {
                padding: 8px;
            }
            
            #company-info, #result {
                padding: 15px;
            }
            
            #company-info p {
                margin-bottom: 10px;
            }
            
            .criteria-list ul li {
                padding: 10px 10px 10px 30px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Vérification d'éligibilité au Chèque Numérique</h1>
        <p class="subtitle">Aide de la Région Ile-de-France pouvant atteindre 1500 Euros</p>
        
        <div class="search-container">
            <input type="text" id="siretInput" placeholder="Entrez le numéro SIREN ou SIRET">
            <button onclick="searchEntreprise()">Vérifier l'éligibilité</button>
        </div>
        
        <div class="results-layout" id="results-container" style="display: none;">
            <div id="company-info"></div>
            <div id="result"></div>
        </div>
        
        <div class="more-info" id="more-info" style="display: none;">
            <a href="https://www.iledefrance.fr/aides-et-appels-a-projets/cheque-numerique-pour-un-commerce-connecte" target="_blank">En savoir plus</a>
        </div>
    </div>

    <script>
        function formatNumber(num) {
            return new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(num);
        }

        function formatDate(dateString) {
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return new Date(dateString).toLocaleDateString('fr-FR', options);
        }

        function checkEntrepriseStatus(entreprise) {
            const data = entreprise || {};
            const siege = data.siege || {};
            
            // --- Dirigeant ---
            let dirigeant = 'Inconnu';
            if (data.dirigeants?.[0]) {
                const d = data.dirigeants[0];
                dirigeant = `${d.prenoms || ''} ${d.nom || ''}`.trim();
            }
            
            // --- Dates ---
            const dateCreation = new Date(siege.date_creation || data.date_creation);
            const now = new Date();
            const date3ans = new Date(now);
            date3ans.setFullYear(now.getFullYear() - 3);
            const date6mois = new Date(now);
            date6mois.setMonth(now.getMonth() - 6);
            
            // --- Ancienneté ---
            const isAnciennete3ans = dateCreation <= date3ans;
            const isAnciennete6mois = dateCreation <= date6mois;
            
            // --- Effectif ---
            const tranche = siege.tranche_effectif_salarie || data.tranche_effectif_salarie;
            const effectifMap = {
                "00": 0, "01": 1, "02": 3, "03": 6, "11": 10, "12": 20, "21": 50, "22": 100,
                "31": 200, "32": 250, "41": 500, "42": 1000, "51": 2000, "52": 5000, "53": 10000
            };
            const effectifMin = tranche ? (effectifMap[tranche] ?? 0) : 0;
            const isEffectifProspectOK = effectifMin >= 2;
            const isEffectifChequeOK = effectifMin < 20;
            
            // --- Statut administratif ---
            const isActif = (siege.etat_administratif || data.etat_administratif) === "A";
            
            // --- Département IDF ---
            const departement = siege.departement || (data.siege?.departement);
            const isIDF = ['75','77','78','91','92','93','94','95'].includes(departement);
            
            // --- NAF ---
            const codeNAF = data.activite_principale || '';
            const codeNAFRoot = codeNAF.slice(0, 2);
            const nafOK = ['10','11','12','13','14','15','16','17','18','19','20','21','22','23','24','25','26','27','28','29','30','31','32','33','43','44','45','46','47','55','56','79','81','95','96'];
            const nafZOK = ['7410Z', '7420Z', '9003A', '9312', '9313'];
            const isNAFEligible = nafOK.includes(codeNAFRoot) || nafZOK.includes(codeNAF);
            const nafBlacklist = ['62','63','64','65','66','68','70','71','73','74','85'];
            const isExcludedNAF = nafBlacklist.includes(codeNAFRoot);
            
            // --- Registre RCS ou RM ---
            const isRegistreValide = Boolean(
                siege.activite_principale_registre_metier || 
                data.nature_juridique?.startsWith('1') || 
                data.nature_juridique?.startsWith('5')
            );
            
            // --- Critères non remplis (diagnostic) ---
            const raisonsProspect = [];
            if (!isActif) raisonsProspect.push("Entreprise inactive");
            if (!isAnciennete3ans) raisonsProspect.push("Moins de 3 ans d'existence");
            if (!isEffectifProspectOK) raisonsProspect.push("Moins de 2 salariés");
            
            const raisonsCheque = [];
            if (!isNAFEligible) raisonsCheque.push("Code NAF non éligible");
            if (isExcludedNAF) raisonsCheque.push("Secteur exclu");
            if (!isIDF) raisonsCheque.push("Hors Île-de-France");
            if (!isAnciennete6mois) raisonsCheque.push("Moins de 6 mois d'existence");
            if (!isEffectifChequeOK) raisonsCheque.push("Effectif ≥ 20");
            if (!isRegistreValide) raisonsCheque.push("Non inscrit RCS/RM");
            if (!isActif) raisonsCheque.push("Entreprise inactive");
            
            // --- Résultats globaux ---
            const statutProspect = raisonsProspect.length === 0 ? 'Validé' : 'A vérifier';
            const chequeNumerique = raisonsCheque.length === 0 ? 'Eligible' : 'Non Eligible';
            
            // --- Critères détaillés pour l'affichage ---
            const criteres = {
                actif: { status: isActif, message: "Entreprise active" },
                naf: { status: isNAFEligible && !isExcludedNAF, message: "Code NAF éligible" },
                idf: { status: isIDF, message: "Établissement en Île-de-France" },
                anciennete: { status: isAnciennete6mois, message: "Créée depuis au moins 6 mois" },
                effectif: { status: isEffectifChequeOK, message: "Effectif inférieur à 20 salariés" },
                registre: { status: isRegistreValide, message: "Inscription au Registre du Commerce/Métiers" }
            };
            
            return {
                statutProspect,
                chequeNumerique,
                raisonsProspect,
                raisonsCheque,
                criteres,
                dirigeant,
                effectifMin,
                departement,
                codeNAF,
                isIDF,
                dateCreation
            };
        }

        async function searchEntreprise() {
            const siret = document.getElementById('siretInput').value.replace(/\s/g, '');
            const resultDiv = document.getElementById('result');
            
            if (siret.length === 0) {
                resultDiv.innerHTML = '<p>Veuillez entrer un numéro SIRET.</p>';
                return;
            }

            resultDiv.innerHTML = '<p>Recherche en cours...</p>';

            try {
                const proxyUrl = 'https://corsproxy.io/?';
                const targetUrl = `https://recherche-entreprises.api.gouv.fr/search?q=${siret}&page=1&per_page=1`;
                const response = await fetch(proxyUrl + encodeURIComponent(targetUrl));
                const data = await response.json();

                if (data.results && data.results.length > 0) {
                    const entreprise = data.results[0];
                    const status = checkEntrepriseStatus(entreprise);
                    
                    const statusEmoji = status.chequeNumerique === 'Eligible' ? "✅" : "❌";
                    const statusClass = status.chequeNumerique === 'Eligible' ? "eligible" : "not-eligible";
                    
                    let criteriaHtml = '';
                    for (const [key, value] of Object.entries(status.criteres)) {
                        const criteriaEmoji = value.status ? "✅" : "❌";
                        criteriaHtml += `
                            <div class="criteria-item">
                                <span class="criteria-status">${criteriaEmoji}</span>
                                <span>${value.message}</span>
                            </div>
                        `;
                    }
                    
                    let raisonsHtml = '';
                    if (status.raisonsCheque.length > 0) {
                        raisonsHtml = `
                            <div class="reasons-list">
                                <strong>Raisons de non-éligibilité:</strong>
                                <ul>
                                    ${status.raisonsCheque.map(raison => `<li>${raison}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                    }
                    
                    const resultsContainer = document.getElementById('results-container');
                    resultsContainer.style.display = 'grid';
                    
                    // Afficher le lien "En savoir plus"
                    document.getElementById('more-info').style.display = 'block';
                    
                    const companyInfoDiv = document.getElementById('company-info');
                    companyInfoDiv.innerHTML = `
                        <h3>Informations de l'entreprise</h3>
                        <p><strong>SIRET:</strong> ${siret}</p>
                        <p><strong>SIREN:</strong> ${entreprise.siren}</p>
                        <p><strong>Code NAF:</strong> ${status.codeNAF || 'Non disponible'}</p>
                        <p><strong>Département:</strong> ${status.departement || 'Non disponible'} ${status.isIDF ? '(Île-de-France)' : ''}</p>
                        <p><strong>Date de création:</strong> ${formatDate(status.dateCreation)}</p>
                        <p><strong>Effectif:</strong> ${status.effectifMin} salariés minimum</p>
                        <p><strong>État administratif:</strong> ${entreprise.etat_administratif === "A" ? "Active" : "Fermée"}</p>
                        <p><strong>Dirigeant:</strong> ${status.dirigeant}</p>
                    `;
                    
                    resultDiv.innerHTML = `
                        <div class="result-section">
                            <h2>${entreprise.nom_complet}</h2>
                            <p class="${statusClass}">${statusEmoji} ${status.chequeNumerique === 'Eligible' ? 
                                "Entreprise éligible au chèque numérique" : 
                                "Entreprise non éligible au chèque numérique"}</p>
                            ${raisonsHtml}
                        </div>
                        
                        <div class="result-section">
                            <h3>Vérification des critères</h3>
                            ${criteriaHtml}
                        </div>
                    `;
                } else {
                    const resultsContainer = document.getElementById('results-container');
                    resultsContainer.style.display = 'block';
                    document.getElementById('company-info').innerHTML = '';
                    resultDiv.innerHTML = '<p>Aucune entreprise trouvée pour ce SIRET.</p>';
                    
                    // Afficher le lien "En savoir plus" même si l'entreprise n'est pas trouvée
                    document.getElementById('more-info').style.display = 'block';
                }
            } catch (error) {
                resultDiv.innerHTML = `<p>Une erreur s'est produite: ${error.message}</p>`;
            }
        }

        document.getElementById('siretInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchEntreprise();
            }
        });
    </script>
    <div class="footer">
        <p style="text-align: center;">&copy; 2025 Exedigit - Chèque Numérique</p>
    </div>
</body>
</html>
